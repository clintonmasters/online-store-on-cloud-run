resources:
  - name: source_code
    type: GitRepo
    configuration:
      gitProvider: Github
      path: gdg-cloud-montreal/microservices-demo
  - name: docker_frontend_build_info
    type: BuildInfo
    configuration:
      sourceArtifactory: artifactory
      buildName: build_and_deploy_cloudrun_pipeline
      buildNumber: ${run_number}

pipelines:
  - name: build_and_deploy_cloudrun_pipeline
    steps:
    - name: build_frontend_docker
      type: DockerBuild
      configuration:
        affinityGroup: fmkGroup
        dockerFileLocation: src/frontend
        dockerFileName: Dockerfile
        dockerImageName: ${int_server_name_value}.jfrog.io/boutique/frontend
        dockerImageTag: ${run_number}
        dockerOptions: --build-arg SERVER_NAME=${int_server_name_value}
        integrations:        
          - name: artifactory
          - name: server_name
        inputResources:
          - name: source_code
    - name: push_frontend_docker
      type: DockerPush
      configuration:
        affinityGroup: fmkGroup
        targetRepository: docker-local
        autoPublishBuildInfo: true
        integrations:
          - name: artifactory
        inputSteps:
          - name: build_frontend_docker
        outputResources:
          - name: docker_frontend_build_info
    - name: xray_scan_frontend_docker
      type: XrayScan
      configuration:
        affinityGroup: fmkGroup
        failOnScan: false
        inputSteps:
          - name: push_frontend_docker
        inputResources:
          - name: docker_frontend_build_info
            trigger: false
    - name: gcloud_deploy_frontend
      type: Bash
      configuration:
        affinityGroup: fmkGroup
        inputSteps:
          - name: xray_scan_frontend_docker
        inputResources:
          - name: docker_frontend_build_info
        runtime:
          type: image
          image:
            custom:
              name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
              tag: "latest"
        integrations:
          - name: gcp_login
          - name: knativeService
          - name: server_name
      execution:
        onExecute:
        - echo $int_gcp_login_jsonkey > /tmp/json.key
        - echo $int_knativeService_service > /tmp/knativeService.yaml
        - gcloud auth activate-service-account $int_gcp_login_user --key-file /tmp/json.key
        - | 
          gcloud run deploy shop-frontend \
          --image  ${int_server_name_value}.jfrog.io/boutique/frontend:${run_number} \
          --cluster cluster-1 --namespace cloud-run-sandbox --cluster-location us-central1-c \
          --platform gke --project $int_gcp_login_project \
          --set-env-vars "PRODUCT_CATALOG_SERVICE_ADDR=productcatalogservice.cloud-run-sandbox.svc.cluster.local:80" \
          --set-env-vars "CURRENCY_SERVICE_ADDR=currencyservice.cloud-run-sandbox.svc.cluster.local:80" \
          --set-env-vars "CART_SERVICE_ADDR=cartservice.cloud-run-sandbox.svc.cluster.local:80" \
          --set-env-vars "RECOMMENDATION_SERVICE_ADDR=recommendationservice.cloud-run-sandbox.svc.cluster.local:80" \
          --set-env-vars "SHIPPING_SERVICE_ADDR=shippingservice.cloud-run-sandbox.svc.cluster.local:80" \
          --set-env-vars "CHECKOUT_SERVICE_ADDR=checkoutservice.cloud-run-sandbox.svc.cluster.local:80" \
          --set-env-vars "AD_SERVICE_ADDR=adservice.cloud-run-sandbox.svc.cluster.local:80"

        
